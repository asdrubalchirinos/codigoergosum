---
import "../styles/global.css";

interface Props {
  title: string;
  description: string;
  image?: string;
  author?: string;
  isArticle?: boolean;
  imageAlt?: string;
  publishDate?: Date | string;
  modifiedDate?: Date | string;
  tags?: string[];
  imageWidth?: number;
  imageHeight?: number;
}

import fs from "node:fs";
import path from "node:path";
import sizeOf from "image-size";

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const SITE_NAME = "Código Ergo Sum";
const DEFAULT_DESC =
  "Descubre en Código ergo sum cómo los cambios laborales y tecnológicos están transformando los negocios. Exploramos desarrollo de software, gestión del tiempo e impacto de la inteligencia artificial. Únete y navega el panorama laboral con éxito.";
const OG_LOCALE = "es_ES";
const TWITTER_HANDLE = import.meta.env.PUBLIC_TWITTER_HANDLE; // opcional

const {
  title,
  description,
  image = "/codigoergosum.png",
  author,
  isArticle = false,
  imageAlt = title,
  publishDate,
  modifiedDate,
  tags = [],
  imageWidth,
  imageHeight,
} = Astro.props as Props;

// Fallback dimensions detection if not provided
let detectedWidth: number | undefined = imageWidth;
let detectedHeight: number | undefined = imageHeight;
if ((!imageWidth || !imageHeight) && image) {
  try {
    const rel = image.startsWith("/") ? image : `/${image}`;
    const filePath = path.join(process.cwd(), "public", rel);
    if (fs.existsSync(filePath)) {
      const dims = sizeOf(filePath);
      if (dims.width) detectedWidth = dims.width;
      if (dims.height) detectedHeight = dims.height;
    }
  } catch (e) {
    // Ignore errors silently; dimensions are optional
  }
}

const finalDescription =
  description && description.trim().length > 0 ? description : DEFAULT_DESC;

let jsonLd: Record<string, unknown> | null = null;
if (isArticle) {
  const publishedISO = publishDate
    ? new Date(publishDate).toISOString()
    : undefined;
  const modifiedISO = modifiedDate
    ? new Date(modifiedDate).toISOString()
    : publishedISO;
  jsonLd = {
    "@context": "https://schema.org",
    "@type": "Article",
    headline: title,
    description: finalDescription,
    image: new URL(image, Astro.site).toString(),
    author: author ? { "@type": "Person", name: author } : undefined,
    url: canonicalURL.toString(),
    mainEntityOfPage: canonicalURL.toString(),
    datePublished: publishedISO,
    dateModified: modifiedISO,
    keywords: tags.length ? tags.join(", ") : undefined,
  };
}
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/jpeg" href="/favicon.jpg" />
<meta name="generator" content={Astro.generator} />
<meta name="author" content={author || "Asdrúbal Chirinos"} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={finalDescription} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={isArticle ? "article" : "website"} />
<meta property="og:site_name" content={SITE_NAME} />
<meta property="og:locale" content={OG_LOCALE} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={title} />
<meta property="og:description" content={finalDescription} />
<meta property="og:image" content={new URL(image, Astro.site)} />
<meta property="og:image:alt" content={imageAlt} />
{
  detectedWidth && (
    <meta property="og:image:width" content={String(detectedWidth)} />
  )
}
{
  detectedHeight && (
    <meta property="og:image:height" content={String(detectedHeight)} />
  )
}
<meta
  property="og:image:type"
  content={`image/${image.split(".").pop()?.toLowerCase().replace("jpg", "jpeg") || "png"}`}
/>
{author && <meta property="article:author" content={author} />}
{
  publishDate && (
    <meta
      property="article:published_time"
      content={new Date(publishDate).toISOString()}
    />
  )
}
{
  modifiedDate && (
    <meta
      property="article:modified_time"
      content={new Date(modifiedDate).toISOString()}
    />
  )
}
{tags.length > 0 && <meta property="article:section" content={tags[0]} />}
{tags.map((tag) => <meta property="article:tag" content={tag} />)}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonicalURL} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={finalDescription} />
<meta name="twitter:image" content={new URL(image, Astro.site)} />
<meta name="twitter:image:alt" content={imageAlt} />
{TWITTER_HANDLE && <meta name="twitter:site" content={TWITTER_HANDLE} />}
{author && <meta name="twitter:creator" content={TWITTER_HANDLE || author} />}

<!-- Structured Data (JSON-LD) -->
{
  jsonLd && (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(jsonLd)}
    />
  )
}
