---
import BaseLayout from "../layouts/BaseLayout.astro";
import { SITE_DESCRIPTION } from "../consts";

// Initial state is loading/processing
let title = "Confirmación de suscripción";
let message = "Procesando tu confirmación...";
---

<BaseLayout title={title} description={SITE_DESCRIPTION}>
    <div class="container">
        <div id="card" class="card">
            <h1 id="title">{title}</h1>
            <p id="message">{message}</p>
            <a href="/" class="button">Volver al inicio</a>
        </div>
    </div>
</BaseLayout>

<style>
    .container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
        padding: 1rem;
    }

    .card {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 100%;
    }

    .card.success {
        border-top: 4px solid green;
    }

    .card.error {
        border-top: 4px solid red;
    }

    h1 {
        margin-top: 0;
        color: rgb(var(--black));
    }

    p {
        margin-bottom: 2rem;
        color: rgb(var(--gray));
    }

    .button {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        background-color: rgb(var(--accent));
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        transition: background-color 0.2s;
    }

    .button:hover {
        background-color: rgb(var(--accent-dark));
    }
</style>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");
    const status = urlParams.get("status");
    const error = urlParams.get("error");

    const card = document.getElementById("card");
    const titleEl = document.getElementById("title");
    const messageEl = document.getElementById("message");

    function showSuccess() {
        if (card) card.classList.add("success");
        if (titleEl) titleEl.textContent = "¡Suscripción confirmada!";
        if (messageEl)
            messageEl.textContent =
                "Gracias por confirmar tu suscripción. Pronto recibirás noticias nuestras.";
    }

    function showError(msg?: string) {
        if (card) card.classList.add("error");
        if (titleEl) titleEl.textContent = "Error en la confirmación";
        if (messageEl)
            messageEl.textContent =
                msg ||
                "Hubo un problema al confirmar tu suscripción. El enlace podría haber expirado o ser inválido.";
    }

    if (status === "success") {
        showSuccess();
    } else if (error) {
        showError();
    } else if (token) {
        // We have a token, let's validate it
        const apiUrl =
            import.meta.env.PUBLIC_NEWSLETTER_API_URL ||
            "http://localhost:8787";

        fetch(`${apiUrl}/api/confirm?token=${token}`)
            .then((response) => {
                if (response.ok) {
                    // Success! Update UI directly without reload
                    showSuccess();
                    // Optional: Update URL to reflect success without reload
                    window.history.replaceState(
                        {},
                        "",
                        "/confirm?status=success",
                    );
                } else {
                    showError();
                    window.history.replaceState(
                        {},
                        "",
                        "/confirm?error=invalid_token",
                    );
                }
            })
            .catch((err) => {
                console.error(err);
                showError("Error de conexión. Por favor intenta de nuevo.");
            });
    }
</script>
